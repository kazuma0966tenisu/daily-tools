<script type="module">
        // CDNから直接、確実にライブラリをインポートします
        import imglyRemoveBackground from "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.4.3/dist/browser/bundle.mjs";

        const imageInput = document.getElementById('imageInput');
        const originalImage = document.getElementById('originalImage');
        const processedImage = document.getElementById('processedImage');
        const downloadBtn = document.getElementById('downloadBtn');
        const loading = document.getElementById('loading');

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // UIの初期化
            originalImage.src = URL.createObjectURL(file);
            originalImage.style.display = 'block';
            processedImage.style.display = 'none';
            downloadBtn.style.display = 'none';
            loading.style.display = 'block';
            loading.innerText = 'AIが背景を切り抜いています...（少々お待ちください）';

            try {
                // AIモデル（ONNXやWASM）の読み込み元も同じCDNに統一します
                const config = {
                    publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.4.3/dist/"
                };

                // 背景透過を実行
                const blob = await imglyRemoveBackground(file, config);
                
                // 処理結果の画像を表示
                const url = URL.createObjectURL(blob);
                processedImage.src = url;
                processedImage.style.display = 'block';
                
                // ダウンロードボタンの設定
                downloadBtn.href = url;
                const originalName = file.name.split('.')[0];
                downloadBtn.download = `${originalName}-nobg.png`;
                downloadBtn.style.display = 'inline-block';

            } catch (error) {
                console.error("背景透過エラー:", error);
                alert("画像の処理中にエラーが発生しました。");
            } finally {
                loading.style.display = 'none';
            }
        });
    </script>
